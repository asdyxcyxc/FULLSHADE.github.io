---
layout: single
title: Windows anti-debugger techniques in C
---

When conducting malware research, reverse engineering or any kind of analysis, debugging will come into play sooner or later. Demonstrated within this article are a few common techniques that malware may try to utilize to evade and not let your debuggers work properly when trying to analyze the malicious pieces of code. The topics below will also include code written in C to fully demonstrate the evasion techniques.

----

**IsDebuggerPresent()**

The first and one of the most simple techniques malware may try and use against an analyst is using the IsDebuggerPresent function provided by Microsoft (for a legitimate purpose).

```c
BOOL IsDebuggerPresent();
```

Taken from MSDN documentation, there are no required parameters when filling out this function. A simple C program that would try and evade a user-mode debugger is as shown below.

```c
#include <Windows.h>
#include <stdio.h>

int main(){

    if (IsDebuggerPresent()){
        printf("Debugger is active!");
        exit(1);
    }

    return 0;
}
```

![windbg having a bad day](https://raw.githubusercontent.com/FULLSHADE/FULLSHADE.github.io/master/static/img/_posts/antidebug1.png)

The way this works is that when the API function is called, it checks against the PEB (Process Environment Block) on the 3rd value, which is `0x002 BeingDebugged`, it checks it's value to determine if the current process is being debugged or not.

After this application exits, you can view the populated values version of the PEB and you can see the BeingDebugged field is set to `1` which tells the "malicious" function call to check if it's in a debugging environment.

```c
0:000> dt _peb @$peb
ntdll!_PEB
   +0x000 InheritedAddressSpace : 0 ''
   +0x001 ReadImageFileExecOptions : 0 ''
   +0x002 BeingDebugged    : 0x1 ''
```

----

**FindWindowA()**

Using the `FindWindowA` Windows function as an anti-debugger technique works under the premise that this specific function is used to obtain a handle to the top-level window whose class and window name matches the provided parameter specified strings.

```c
HWND FindWindowA(
  LPCSTR lpClassName,
  LPCSTR lpWindowName
);
```

The parameters: `lpClassName` is used to provide the class name which you want to match which is registered by the functions RegisterClass or RegisterClassEx. For `lpWindowName` you set the window's title if this is set to `NULL` all the windows names will be set to match. You just need to find the window name of an application. This can be done with basic google research.

```c
#include <windows.h>
#include <stdio.h>

int main(){

    BOOL results = FALSE;
    LPCSTR DetectOlly = "OLLYDBG";
    LPCSTR DetectWinDBG = "WinDbgFrameClass";

    printf("[+] Checking for a debugger...");

    if (FindWindowA(DetectOlly, 0) || FindWindow(DetectWinDBG, 0)){
        MessageBoxA(NULL, "Debugger detected", "Notification", MB_OK);
        exit(1);
    } else {
        MessageBoxA(NULL, "No Debugger detected", "Notification", MB_OK);
    }

    return 0;
}

```

![ollydbg having a bad day](https://raw.githubusercontent.com/FULLSHADE/FULLSHADE.github.io/master/static/img/_posts/antidebug2.png)

----

**References**

- http://www.cs.utah.edu/~aburtsev/malw-sem/slides/02-anti-debugging.pdf
